{% extends "base.html" %}
{% load static %}
{% block title %}Respondiendo: {{ sesion.cuestionario.codigo }}{% endblock %}

{% block content %}
<style>
/* Estilos del Dashboard */
:root{
  --uaeh-rojo:#B91116; --uaeh-naranja:#E24622;
  --uaeh-rojo-osc:#841816; --uaeh-naranja-osc:#E3641C;
  --bg:#f6f7fb; --card:#ffffff; --tx:#263238; --muted:#7b8a8f;
  --danger:#B72136;
  --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.06);
}
.content.eval-wrap{
  max-width:800px;
  margin-inline:auto;
}
.card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; margin-bottom: 24px; }
.card-title{ margin:0 0 10px; font-size:1.15rem; color:#111827; font-weight:800; }
.q-card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px 18px; margin-bottom: 20px; border-left: 5px solid var(--uaeh-rojo); }
.q-num{ font-weight: 900; color: var(--uaeh-rojo); font-size: 1.1rem; }
.q-text{ font-weight: 700; color: var(--tx); font-size: 1.1rem; margin: 8px 0 12px; }
.q-ayuda{ font-size: 0.9rem; color: var(--muted); margin: 0 0 12px; font-style: italic; }
.q-opciones { display: grid; gap: 10px; }
.q-opciones label {
  display: flex; align-items: center; gap: 10px;
  background: #f8f9fa;
  border: 1px solid #eef1f4;
  border-radius: 12px;
  padding: 12px 14px;
  cursor: pointer;
  transition: .15s ease;
}
.q-opciones label:hover { background: #f1f3f7; }
.q-opciones input[type="radio"], .q-opciones input[type="checkbox"] {
  width: 1.2em; height: 1.2em;
  accent-color: var(--uaeh-rojo);
  flex-shrink: 0;
}
.q-opciones input[type="text"], .q-opciones textarea, .q-opciones input[type="number"] {
  width: 100%; appearance:none;
  background:#fff; color:#111827;
  border:1px solid #e2e8f0; border-radius:12px;
  padding:.7rem .85rem; font-size:1rem;
}
.btn-primary{
  cursor:pointer; border:1px solid transparent; padding:.6rem 1.2rem;
  border-radius:12px; font-weight:800;
  background:linear-gradient(135deg,var(--uaeh-rojo),var(--uaeh-naranja));
  color:#fff; transition:.15s ease; box-shadow:0 1px 0 rgba(0,0,0,.02)
}
.btn-primary:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.06)}
.btn-primary:disabled{ opacity: 0.6; cursor: not-allowed; }



.escala-wrap{
  display: grid !important;
  grid-template-columns: repeat(5, minmax(120px, 1fr)) !important;
  gap: 12px !important;
  justify-items: stretch;
  align-items: stretch;
  margin-top: 12px !important;
}

@media (max-width: 980px){
  .escala-wrap{ grid-template-columns: repeat(3, minmax(140px, 1fr)) !important; }
}
@media (max-width: 720px){
  .escala-wrap{ grid-template-columns: repeat(2, minmax(140px, 1fr)) !important; }
}
@media (max-width: 420px){
  .escala-wrap{ grid-template-columns: 1fr !important; }
}

/* 3) Tarjeta Likert: centrado real (radio + n√∫mero + texto) */
.escala-wrap .likert-option{
  min-height: 130px;
  padding: 14px 12px !important;
  border-radius: 14px !important;
  background: #ffffff !important;
  border: 1px solid #e6edf5 !important;
  box-shadow: 0 6px 18px rgba(0,0,0,.04);
  display: grid !important;
  grid-template-rows: auto auto auto;
  align-content: center;
  justify-items: center;
  text-align: center;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}

/* hover sutil */
.escala-wrap .likert-option:hover{
  transform: translateY(-1px);
  border-color: rgba(185,17,22,.25);
  box-shadow: 0 10px 22px rgba(0,0,0,.06);
  background: linear-gradient(135deg, rgba(226, 70, 34, 0.08), rgba(226, 70, 34, 0));
}

/* 4) Radio arriba centrado */
.escala-wrap .likert-option input[type="radio"]{
  margin: 0 0 10px 0 !important;
  width: 1.25em;
  height: 1.25em;
  accent-color: var(--uaeh-rojo);
}

/* 5) N√∫mero grande y claro */
.escala-wrap .likert-option .num{
  font-size: 1.35rem !important;
  font-weight: 900 !important;
  color: #0f172a !important;
  line-height: 1.1;
  margin-bottom: 6px;
}

/* 6) Texto de etiqueta (Nada/Poco/Medio/...) */
.escala-wrap .likert-option .txt{
  font-size: .95rem !important;
  font-weight: 800 !important;
  color: #64748b !important;
  line-height: 1.2;
}

/* 7) Estado seleccionado: muy evidente y ‚ÄúUAEH‚Äù */
.escala-wrap .likert-option.is-checked{
  border-color: rgba(185,17,22,.55) !important;
  box-shadow: 0 14px 28px rgba(185,17,22,.12) !important;
  background: linear-gradient(135deg, rgba(185, 17, 22, 0.10), rgba(226, 70, 34, 0.06)) !important;
}

.escala-wrap .likert-option.is-checked .num{
  color: var(--uaeh-rojo) !important;
}
.escala-wrap .likert-option.is-checked .txt{
  color: #475569 !important;
}

/* 8) Mejor spacing para la tarjeta completa de pregunta (opcional, no rompe nada) */
.q-card{
  padding: 22px 18px;
}
.q-text{
  margin-top: 10px;
  margin-bottom: 14px;
}

/* Estilo para S√≠/No */
.sino-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}


/* tarjetas */
.likert-option{ min-height:110px; }

/* toggle de definiciones */
.likert-help{
  margin-top:8px;
  font-size:.95rem;
  color:#475569;
}
.likert-help > summary{
  cursor:pointer;
  list-style:none;
}
.likert-help > summary::marker{ content:""; }
.likert-legend{
  margin:8px 0 0; padding-left:18px;
}
.likert-legend li{
  margin:4px 0;
}
/* Likert en regla horizontal */
.likert-ruler{padding:10px 6px}
.likert-rail{height:4px;background:#e5e7eb;border-radius:9999px;margin:8px 0 14px}
.likert-marks{display:flex;justify-content:space-between;align-items:flex-start;gap:6px}
.likert-mark{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:36px}
.likert-dot{width:26px;height:26px;border:2px solid var(--uaeh-rojo);border-radius:9999px;background:#fff;display:grid;place-items:center;cursor:pointer;transition:.15s}
.likert-dot input{display:none}
.likert-dot.is-checked, .likert-dot:hover{background:var(--uaeh-rojo);color:#fff}
.likert-num{font-weight:700;font-size:.95rem;line-height:1}
.likert-ends{display:flex;justify-content:space-between;color:var(--muted);font-size:.9rem;margin-top:-4px}
.likert-ends span{max-width:40%;text-wrap:balance}
.likert-neutral{color:var(--muted);font-size:.9rem;text-align:center;margin-top:6px}
.q-card.q-error { border-right-color: #B72136 !important; }
.q-msg-error{ color:#B72136;font-size:.95rem;margin-top:6px }

.likert-option .txt{font-size:.92rem;color:var(--muted);font-weight:700}
.likert-option .num{font-size:1.05rem;font-weight:900}


/* ===== UX extras: progreso + sticky submit + enfoque accesible ===== */

/* Badge ‚ÄúObligatoria‚Äù */
.badge-req{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-weight:800;
  font-size:.82rem;
  color:#7a1a1a;
  background: rgba(183,33,54,.08);
  border:1px solid rgba(183,33,54,.16);
  padding:4px 8px;
  border-radius:999px;
  margin-left:8px;
}

/* Mejor foco (teclado) */
.q-card :focus-visible{
  outline: 3px solid rgba(226,70,34,.35);
  outline-offset: 3px;
  border-radius: 12px;
}

/* Sticky submit */
.submit-sticky{
  position: sticky;
  bottom: 12px;
  z-index: 25;
  display:flex;
  justify-content:center;
  padding: 10px;
}

.submit-sticky .submit-inner{
  width: 100%;
  max-width: 820px;
  background: rgba(255,255,255,.9);
  backdrop-filter: blur(10px);
  border: 1px solid #eef1f4;
  border-radius: 18px;
  box-shadow: 0 16px 38px rgba(0,0,0,.10);
  padding: 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.submit-hint{
  color: var(--muted);
  font-weight: 700;
  font-size: .95rem;
}

@media (max-width: 600px){
  .submit-sticky .submit-inner{flex-direction:column; align-items:stretch;}
  .submit-hint{text-align:center}
}
/* Resalta la tarjeta que falta por contestar */
.q-card.q-error {
    border: 2px solid var(--danger) !important;
    background-color: rgba(183, 33, 54, 0.02);
    animation: shake 0.4s ease-in-out; /* Efecto visual de error */
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

</style>

<div class="content eval-wrap">
  <div class="card">
    <h3 style="margin:0; color:var(--uaeh-rojo)">{{ sesion.cuestionario.nombre }}</h3>
    <p class="muted" style="margin:0">{{ sesion.cuestionario.descripcion|default:"Responde todas las preguntas." }}</p>
  </div>
  
{# --- Mensajes flash --- #}
{% if messages %}
  {% for message in messages %}
    <div class="card flash {% if 'error' in message.tags %}flash--error{% else %}flash--warning{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}




<form method="POST" id="evalForm">
  {% csrf_token %}
  <input type="hidden" name="sesion_id" value="{{ sesion.id }}">

  {# ====== Bucle de preguntas (UNO SOLO) ====== #}
  {% for pregunta in preguntas %}
    <article class="q-card"
             data-tipo="{{ pregunta.tipo_respuesta }}"
             data-requerido="{{ pregunta.requerido|yesno:'true,false' }}">
      <span class="q-num">Pregunta {{ forloop.counter }}</span>
      <p class="q-text">{{ pregunta.texto }}</p>

      {# Ayuda solo si NO es escala #}
      {% if pregunta.tipo_respuesta != 'ESCALA' and pregunta.ayuda %}
        <p class="q-ayuda">‚ìò {{ pregunta.ayuda }}</p>
      {% endif %}

      <div class="q-opciones">

        {# ---- Tipos de respuesta ---- #}
        {% if pregunta.tipo_respuesta == 'OPCION_UNICA' %}
          {% for opcion in pregunta.opciones.all %}
            <label>
              <input type="radio"
                     name="preg_{{ pregunta.id }}"
                     value="{{ opcion.id }}"
                     {% if pregunta.requerido %}{% endif %}>
              <span>{{ opcion.texto }}</span>
            </label>
          {% endfor %}

        {% elif pregunta.tipo_respuesta == 'OPCION_MULTIPLE' %}
          {% for opcion in pregunta.opciones.all %}
            <label>
              <input type="checkbox"
                     name="preg_{{ pregunta.id }}[]"
                     value="{{ opcion.id }}"
                     {% if pregunta.requerido %}required{% endif %}>
              <span>{{ opcion.texto }}</span>
            </label>
          {% endfor %}

        {% elif pregunta.tipo_respuesta == 'ESCALA' %}
          {# La escala se renderiza por JS; required se aplica dentro del renderGrid/renderRuler #}
          <div class="js-likert"
               data-name="preg_{{ pregunta.id }}"
               data-min="{{ pregunta.config.min|default:1 }}"
               data-max="{{ pregunta.config.max|default:5 }}"
               data-step="{{ pregunta.config.step|default:1 }}"
               data-required="{{ pregunta.requerido|yesno:'true,false' }}"
               data-labels="{{ pregunta.likert_labels_spec|default:'' }}"
               data-labels-json="{{ pregunta.likert_labels_json|default:'{}' }}">
          </div>

        {% elif pregunta.tipo_respuesta == 'TEXTO' %}
          <textarea name="preg_{{ pregunta.id }}"
                    rows="4"
                    placeholder="Escribe tu respuesta..."
                    {% if pregunta.requerido %}{% endif %}></textarea>

        {% elif pregunta.tipo_respuesta == 'NUMERICA' %}
          <input type="number"
                 name="preg_{{ pregunta.id }}"
                 min="{{ pregunta.config.min|default_if_none:'' }}"
                 max="{{ pregunta.config.max|default_if_none:'' }}"
                 step="{{ pregunta.config.step|default_if_none:'1' }}"
                 placeholder="Escribe un n√∫mero"
                 {% if pregunta.requerido %}{% endif %}>

        {% elif pregunta.tipo_respuesta == 'SI_NO' %}
          <div class="sino-wrap">
            <label>
              <input type="radio"
                     name="preg_{{ pregunta.id }}"
                     value="SI"
                     {% if pregunta.requerido %}{% endif %}>
              <span>S√≠</span>
            </label>
            <label>
              <input type="radio"
                     name="preg_{{ pregunta.id }}"
                     value="NO"
                     {% if pregunta.requerido %}{% endif %}>
              <span>No</span>
            </label>
          </div>
        {% endif %}
        {# ---- FIN Tipos de respuesta ---- #}

      </div>  {# cierre .q-opciones #}
    </article>  {# cierre .q-card #}
  {% endfor %}

  <div class="submit-sticky">
    <div class="submit-inner">
      <div class="submit-hint" id="submitHint">
        Completa todas las preguntas obligatorias para enviar.
      </div>
      <button type="submit" class="btn-primary" id="btnSubmit">
        Finalizar y Enviar Cuestionario
      </button>
    </div>
  </div>
</form>



<script>
(function () {
  function parsePerValue(text) {
    const map = {};
    if (!text) return map;
    text.split(',').forEach(part => {
      const p = part.trim(); if (!p) return;
      const i = p.indexOf('=');
      if (i === -1) return;
      const k = Number(p.slice(0, i).trim());
      const v = p.slice(i + 1).trim();
      if (!Number.isNaN(k)) map[k] = v;
    });
    return map;
  }

  function renderLikert(container) {
    const name = container.dataset.name;
    const min = +container.dataset.min || 1;
    const max = +container.dataset.max || 5;
    const required = container.dataset.required === 'true';
    const labels = parsePerValue(container.dataset.labels || '');

    container.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'escala-wrap';
    container.appendChild(wrap);

    for (let v = min; v <= max; v++) {
      const lbl = document.createElement('label');
      lbl.className = 'likert-option';

      const input = document.createElement('input');
      input.type = 'radio';
      input.name = name;
      input.value = v;
      input.setAttribute('form', 'evalForm'); // üî• CLAVE

      if (required) input.required = true;

      const num = document.createElement('div');
      num.className = 'num';
      num.textContent = v;

      const txt = document.createElement('div');
      txt.className = 'txt';
      txt.textContent = labels[v] || '';

      lbl.appendChild(input);
      lbl.appendChild(num);
      lbl.appendChild(txt);
      wrap.appendChild(lbl);

      input.addEventListener('change', () => {
        wrap.querySelectorAll('.likert-option').forEach(x => x.classList.remove('is-checked'));
        lbl.classList.add('is-checked');
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.js-likert').forEach(renderLikert);
  });
})();
</script>
<script>
(function(){
  const form = document.getElementById('evalForm');
  const btn  = document.getElementById('btnSubmit');
  const hint = document.getElementById('submitHint');
  if (!form) return;

  function markError(card, on) {
    card.classList.toggle('q-error', !!on);
  }

  function isRequired(card){
    return card.dataset.requerido === 'true';
  }

  function detectType(card){
    if (card.querySelector('.js-likert')) return 'ESCALA';
    if (card.querySelector('textarea')) return 'TEXTO';
    if (card.querySelector('input[type="number"]')) return 'NUMERICA';
    if (card.querySelector('input[type="checkbox"]')) return 'OPCION_MULTIPLE';
    if (card.querySelector('input[type="radio"]')) return 'OPCION_UNICA';
    return 'DESCONOCIDO';
  }

  function validateQuestion(card){
    if (!isRequired(card)) { markError(card, false); return true; }

    const tipo = detectType(card);
    let ok = true;

    if (['ESCALA','OPCION_UNICA'].includes(tipo)) {
      ok = !!card.querySelector('input[type="radio"]:checked');
    }
    else if (tipo === 'OPCION_MULTIPLE') {
      ok = !!card.querySelector('input[type="checkbox"]:checked');
    }
    else if (tipo === 'TEXTO') {
      const ta = card.querySelector('textarea');
      ok = ta && ta.value.trim() !== '';
    }
    else if (tipo === 'NUMERICA') {
      const el = card.querySelector('input[type="number"]');
      ok = el && el.value.trim() !== '';
    }

    markError(card, !ok);
    return ok;
  }

  function validateForm(){
    const cards = [...form.querySelectorAll('.q-card')];
    let firstError = null;
    let allOk = true;

    cards.forEach(card => {
      const ok = validateQuestion(card);
      if (!ok && !firstError) firstError = card;
      allOk = allOk && ok;
    });

    if (!allOk && firstError) {
      firstError.scrollIntoView({behavior:'smooth', block:'center'});
      if (hint) hint.textContent = 'Faltan preguntas obligatorias.';
    }

    return allOk;
  }

  // üõë SUBMIT √öNICO Y EN CAPTURA
  form.addEventListener('submit', function(e){
    if (!validateForm()) {
      e.preventDefault();
      e.stopImmediatePropagation();
      return false;
    }
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Enviando respuestas‚Ä¶';
    }
  }, true);

  form.addEventListener('change', e => {
    const card = e.target.closest('.q-card');
    if (card) validateQuestion(card);
  });

})();
</script>




</div>  {# cierra <div class="content eval-wrap"> #}
{% endblock %}  
